{% extends "base.html" %}

{% block title %}Acceso de Usuarios{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/users_styles.css') }}">
    <meta name="description" content="Página de acceso y registro para usuarios de Transporte Unión Salazar.">
{% endblock %}

{% block content %}
<main class="user-access-main">

    <section id="login-section" class="fade-in-section">
        <h2>Iniciar Sesión</h2>
        <form id="login-form">
            <div class="form-group"><label for="login-username">Usuario:</label><input type="text" id="login-username" name="username" required autocomplete="username"></div>
            <div class="form-group">
                <label for="login-password">Contraseña:</label>
                <div class="password-wrapper">
                    <input type="password" id="login-password" name="password" required autocomplete="current-password">
                    <i class="fas fa-eye-slash toggle-password"></i>
                </div>
            </div>
            <button type="submit">Entrar</button>
            <p id="login-message" class="form-message hidden"></p>
        </form>
        <p class="toggle-form-text">¿No tienes una cuenta? <a href="#" id="show-register-link">Regístrate aquí</a></p>
    </section>

    <section id="register-section" class="fade-in-section hidden">
        <h2>Crear Cuenta</h2>
        <form id="register-form">
            <div class="form-group"><label for="register-username">Elige un nombre de usuario:</label><input type="text" id="register-username" name="username" required autocomplete="username"></div>
            <div class="form-group">
                <label for="register-password">Elige una contraseña:</label>
                <div class="password-wrapper">
                    <input type="password" id="register-password" name="password" required autocomplete="new-password">
                    <i class="fas fa-eye-slash toggle-password"></i>
                </div>
            </div>
            <button type="submit">Registrarse</button>
            <p id="register-message" class="form-message hidden"></p>
        </form>
        <p class="toggle-form-text">¿Ya tienes una cuenta? <a href="#" id="show-login-link">Inicia sesión</a></p>
    </section>

    <section id="dashboard-section" class="fade-in-section hidden">
        <div class="dashboard-header">
            <h2>Bienvenido, <span id="welcome-username"></span>!</h2>
            <button id="logout-button">Cerrar Sesión</button>
        </div>
        
        <!-- ================================== -->
        <!-- INICIO: VISTA DE ADMINISTRADOR     -->
        <!-- ================================== -->
        <div id="admin-view" class="hidden">
            <div class="tabs">
                <button class="tab-link active" data-tab="admin-conductores-tab">Conductores</button>
                <button class="tab-link" data-tab="admin-contratos-tab">Contratos</button>
            </div>

            <!-- Pestaña de Conductores -->
            <div id="admin-conductores-tab" class="tab-content active">
                <div id="admin-panel-container">
                    <!-- La lista de conductores se renderiza aquí por JS -->
                </div>
                <div id="admin-driver-details-view" class="hidden">
                    <button id="back-to-list-btn">&larr; Volver a la Lista</button>
                    <h3 id="details-driver-name"></h3>
                    <div class="tabs">
                        <button class="tab-link active" data-tab="admin-expenses-tab">Rendición</button>
                        <button class="tab-link" data-tab="admin-calendar-tab">Calendario</button>
                    </div>
                    <div id="admin-expenses-tab" class="tab-content active">
                        <div id="admin-active-period-container" class="hidden"><div class="period-summary"><h3>Rendición en Curso</h3><div class="summary-details"><p><strong>Patente:</strong> <span id="admin-summary-patente"></span></p><p><strong>Viaje:</strong> <span id="admin-summary-trip"></span></p><p><strong>Monto Inicial:</strong> <span id="admin-summary-initial"></span></p><p><strong>Total Gastado:</strong> <span id="admin-summary-spent"></span></p><p class="saldo"><strong>Saldo Restante:</strong> <span id="admin-summary-balance"></span></p></div></div><h4>Gastos Registrados</h4><div class="table-container"><table id="admin-expenses-table"><thead><tr><th>Fecha</th><th>Categoría</th><th>Notas</th><th>Monto</th></tr></thead><tbody></tbody></table></div></div>
                        <div id="admin-no-period-container"><p>Este conductor no tiene una rendición de gastos activa.</p></div>
                        <div id="admin-history-container"><hr><h4>Historial de Viajes Cerrados</h4><div id="admin-history-list-container"></div></div>
                    </div>
                    <div id="admin-calendar-tab" class="tab-content">
                        <div id="admin-calendar-container"><div class="calendar-legend"><div><span class="day-cell-legend work"></span> Trabajo</div><div><span class="day-cell-legend off"></span> Descanso</div></div><div class="calendar-header"><button id="admin-prev-month-btn" aria-label="Mes anterior">&larr;</button><h4 id="admin-month-title-display" class="month-title"></h4><button id="admin-next-month-btn" aria-label="Mes siguiente">&rarr;</button></div><div class="admin-month-grid-container"></div></div>
                    </div>
                </div>
            </div>

            <!-- Pestaña de Contratos -->
            <div id="admin-contratos-tab" class="tab-content">
                <!-- Vista principal con formularios y lista -->
                <div id="contracts-main-view">
                    <h3>Gestión de Contratos de Servicio</h3>
                    <div class="management-grid">
                        <div class="management-column">
                            <h4><i class="fas fa-user-tie"></i> Crear Nuevo Cliente</h4>
                            <form id="create-client-form">
                                <div class="form-group">
                                    <label for="client-name">Nombre del Cliente:</label>
                                    <input type="text" id="client-name" name="client-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="client-contact-person">Persona de Contacto (Opcional):</label>
                                    <input type="text" id="client-contact-person" name="client-contact-person">
                                </div>
                                <div class="form-group">
                                    <label for="client-contact-email">Email de Contacto (Opcional):</label>
                                    <input type="email" id="client-contact-email" name="client-contact-email">
                                </div>
                                <button type="submit">Guardar Cliente</button>
                                <p id="client-message" class="form-message hidden"></p>
                            </form>
                        </div>

                        <div class="management-column">
                            <h4><i class="fas fa-file-signature"></i> Crear Nuevo Contrato</h4>
                            <form id="create-contract-form">
                                <div class="form-group">
                                    <label for="contract-client-select">Asignar a Cliente:</label>
                                    <select id="contract-client-select" name="contract-client-select" required>
                                        <option value="">Cargando clientes...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="contract-name">Nombre o Descripción del Contrato:</label>
                                    <input type="text" id="contract-name" name="contract-name" required placeholder="Ej: CEA La Reina -> La Serena">
                                </div>
                                <div class="form-group">
                                    <label for="contract-revenue">Ingreso Total del Contrato ($):</label>
                                    <input type="text" inputmode="numeric" id="contract-revenue" name="contract-revenue" required>
                                </div>
                                <div class="form-group">
                                    <label for="contract-start-date">Fecha de Inicio:</label>
                                    <input type="date" id="contract-start-date" name="contract-start-date" required>
                                </div>
                                <div class="form-group">
                                    <label for="contract-end-date">Fecha de Término (Opcional):</label>
                                    <input type="date" id="contract-end-date" name="contract-end-date">
                                </div>
                                <button type="submit">Guardar Contrato</button>
                                <p id="contract-message" class="form-message hidden"></p>
                            </form>
                        </div>
                    </div>
                    <hr>
                    <div class="list-section">
                        <h4><i class="fas fa-list-ul"></i> Contratos Registrados</h4>
                        <div id="contracts-list-container">
                            <!-- La lista de contratos se renderizará aquí por JS -->
                        </div>
                    </div>
                </div>

                <!-- ***** INICIO: PANEL DE DETALLES DE CONTRATO REDISEÑADO ***** -->
                <div id="admin-contract-details-view" class="hidden">
                    <button id="back-to-contracts-list-btn" class="action-btn back-btn">&larr; Volver a la Lista de Contratos</button>
                    <h3 id="details-contract-name"></h3>
                    
                    <h4>Análisis de Rentabilidad Mensual</h4>
                    <div id="monthly-breakdown-container">
                        <!-- La tabla con el desglose mensual se renderizará aquí -->
                    </div>

                    <hr>
                    <h4>Totales del Contrato</h4>
                    <div class="kpi-grid">
                        <div class="kpi-card revenue">
                            <span class="kpi-title">Ingresos Totales</span>
                            <span class="kpi-value" id="grand-total-revenue"></span>
                        </div>
                        <div class="kpi-card expenses">
                            <span class="kpi-title">Gastos de Conductor</span>
                            <span class="kpi-value" id="grand-total-expenses"></span>
                        </div>
                        <div class="kpi-card profit">
                            <span class="kpi-title">Ganancia Neta Total</span>
                            <span class="kpi-value" id="grand-total-profit"></span>
                        </div>
                        <div class="kpi-card margin">
                            <span class="kpi-title">Margen Total (%)</span>
                            <span class="kpi-value" id="grand-total-margin"></span>
                        </div>
                    </div>
                </div>
                <!-- ***** FIN: PANEL DE DETALLES DE CONTRATO REDISEÑADO ***** -->
            </div>
        </div>
        <!-- ================================== -->
        <!-- FIN: VISTA DE ADMINISTRADOR        -->
        <!-- ================================== -->

        <!-- ================================== -->
        <!-- INICIO: VISTA DE CONDUCTOR         -->
        <!-- ================================== -->
        <div id="conductor-view" class="hidden">
            <div class="tabs">
                <button class="tab-link active" data-tab="calendar-tab">Calendario de Turnos</button>
                <button class="tab-link" data-tab="expenses-tab">Rendición de Gastos</button>
            </div>

            <div id="calendar-tab" class="tab-content active">
                <div class="shift-config-container">
                    <h3>Configura tu Turno</h3>
                    <div id="shift-display-view" class="hidden">
                        <div class="current-shift-info">
                            <p><strong>Tu turno actual es:</strong> <span id="display-shift-type"></span></p>
                            <p><strong>Iniciando el:</strong> <span id="display-shift-start-date"></span></p>
                        </div>
                        <button id="change-shift-btn" class="action-btn">Cambiar Turno</button>
                    </div>
                    <form id="shift-config-form">
                        <div class="form-group"><label for="shift-type-select">Tipo de Turno:</label><select id="shift-type-select"><option value="3x3">3x3</option><option value="7x7" selected>7x7</option><option value="14x14">14x14</option></select></div>
                        <div class="form-group"><label for="shift-start-date-input">Fecha de Inicio del Ciclo:</label><input type="date" id="shift-start-date-input" required></div>
                        <button type="submit" id="save-shift-btn">Guardar Turno</button>
                    </form>
                    <p id="shift-message" class="form-message hidden"></p>
                </div>
                <div id="calendar-container">
                    <div class="calendar-legend">
                        <div><span class="day-cell-legend work"></span> Trabajo</div>
                        <div><span class="day-cell-legend off"></span> Descanso</div>
                    </div>
                    <div class="calendar-header">
                        <button id="prev-month-btn" aria-label="Mes anterior">&larr;</button>
                        <h4 id="month-title-display" class="month-title"></h4>
                        <button id="next-month-btn" aria-label="Mes siguiente">&rarr;</button>
                    </div>
                    <div class="month-grid-container"></div>
                </div>
            </div>

            <div id="expenses-tab" class="tab-content">
                <div id="start-period-container">
                    <h3>Iniciar Nueva Rendición</h3>
                    <form id="start-period-form">
                        <div class="form-grid">
                            <div class="form-group"><label for="patente">Patente Vehículo:</label><input type="text" id="patente" name="patente" required></div>
                            <div class="form-group"><label for="rut">RUT Conductor:</label><input type="text" id="rut" name="rut" required></div>
                            <div class="form-group"><label for="trip-origin">Origen del Viaje:</label><input type="text" id="trip-origin" name="trip-origin" required></div>
                            <div class="form-group"><label for="trip-destination">Destino del Viaje:</label><input type="text" id="trip-destination" name="trip-destination" required></div>
                            <div class="form-group full-width"><label for="initial-amount">Monto Inicial Entregado ($):</label><input type="text" inputmode="numeric" id="initial-amount" name="initial-amount" required></div>
                            
                            <div class="form-group full-width">
                                <label for="period-contract-select">Asociar a Contrato (Opcional):</label>
                                <select id="period-contract-select" name="period-contract-select">
                                    <option value="">-- Ninguno --</option>
                                    <!-- La lista de contratos activos se cargará aquí por JS -->
                                </select>
                            </div>

                        </div>
                        <button type="submit">Comenzar Período</button>
                    </form>
                </div>
                <div id="active-period-container" class="hidden">
                    <div class="period-summary">
                        <div class="summary-header">
                            <h3>Rendición en Curso</h3>
                            <button id="close-period-btn" class="close-btn">Cerrar Viaje y Finalizar</button>
                        </div>
                        <div class="summary-details">
                            <p><strong>Patente:</strong> <span id="summary-patente"></span></p>
                            <p><strong>Viaje:</strong> <span id="summary-trip"></span></p>
                            <p><strong>Monto Inicial:</strong> <span id="summary-initial"></span></p>
                            <p><strong>Total Gastado:</strong> <span id="summary-spent"></span></p>
                            <p class="saldo"><strong>Saldo Restante:</strong> <span id="summary-balance"></span></p>
                        </div>
                    </div>
                    <h4>Añadir Nuevo Gasto</h4>
                    <form id="add-expense-form">
                        <div class="form-grid expense-grid">
                            <div class="form-group"><label for="expense-category">Categoría:</label><select id="expense-category" name="expense-category" required><option value="Peajes">Peajes</option><option value="Viáticos">Viáticos</option><option value="Combustible">Combustible</option><option value="Estacionamiento">Estacionamiento</option><option value="Alojamiento">Alojamiento</option><option value="Vulcanización">Vulcanización</option><option value="BlueMax">BlueMax</option><option value="Supermercado">Supermercado</option><option value="Otro">Otro</option></select></div>
                            <div class="form-group"><label for="expense-amount">Monto ($):</label><input type="text" inputmode="numeric" id="expense-amount" name="expense-amount" required></div>
                            <div class="form-group full-width"><label for="expense-notes">Notas (Opcional):</label><input type="text" id="expense-notes" name="expense-notes"></div>
                        </div>
                        <button type="submit">Agregar Gasto</button>
                    </form>
                    <h4>Gastos Registrados</h4>
                    <div class="table-container">
                        <table id="expenses-table">
                            <thead><tr><th>Fecha</th><th>Categoría</th><th>Notas</th><th>Monto</th><th>Acciones</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div id="history-container">
                    <hr>
                    <h4>Historial de Viajes Cerrados</h4>
                    <div id="history-list-container"></div>
                </div>
            </div>
        </div>
        <!-- ================================== -->
        <!-- FIN: VISTA DE CONDUCTOR            -->
        <!-- ================================== -->
        
        <div id="edit-driver-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <button id="close-edit-modal-btn" class="close-button">&times;</button>
                <h2>Editar Conductor</h2>
                <form id="edit-driver-form">
                    <input type="hidden" id="edit-username" name="username">
                    <div class="form-group">
                        <label for="edit-rut">RUT:</label>
                        <input type="text" id="edit-rut" name="rut">
                    </div>
                    <div class="form-group">
                        <label for="edit-phone">Teléfono:</label>
                        <input type="text" id="edit-phone" name="phone">
                    </div>
                    <button type="submit">Guardar Cambios</button>
                    <p id="edit-driver-message" class="form-message hidden"></p>
                </form>
            </div>
        </div>
        
    </section>
</main>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/users_script.js') }}"></script>
{% endblock %}
